#!/bin/sh

. /lib/functions.sh

config_load foris
config_get_bool WIZARD_FINISHED wizard finished "0"
config_get LANG settings lang "en"
config_load webapps
config_get DEFAULT webapps default "reforis"

old_to_json() {
    NAME=""
    URL=""
    DESCRIPTION=""
    ICON=""
    . "$1"
    cat << ENTRY
{
    "id": "$(basename "$1" .conf | sed 's|^[0-9_]*||')",
    "title": "$(echo "$NAME" | sed 's| - .*||')",
    "url": "$URL",
    "icon": "/icons/$ICON",
    "description": {
	"en": "$(echo "$NAME" | sed 's|.* - ||')"
    }
}
ENTRY
}

print_all() {
    local sep=""
    for fl in /usr/share/turris-webapps/[0-9]*.conf /etc/turris-webapps/[0-9]*.conf; do
        [ -f "$fl" ] || continue
        echo -n "$sep"
        old_to_json "$fl"
        sep=","
    done
    for fl in /usr/share/turris-webapps/[0-9]*.json /etc/turris-webapps/[0-9]*.json; do
        [ -f "$fl" ] || continue
        echo -n "$sep"
        cat "$fl"
        sep=","
    done
}

print_default() {
    local fl="$(ls -1 /usr/share/turris-webapps/*$default*.conf | head -n 1)"
    if [ -f "$fl" ]; then
        old_to_json "$fl"
    else
        fl="$(ls -1 /usr/share/turris-webapps/*$default*.json | head -n 1)"
        cat "$fl"
    fi
}

cat << JSON
{
    "lang": "$LANG",
    "selected": "$DEFAULT",
    "langs": {
$(cat /usr/share/turris-webapps/l10n.json)
    },
    "apps": [
$(if [ "$WIZARD_FINISHED" = "1" ]; then print_all; else print_default; fi)
    ]
}
JSON
